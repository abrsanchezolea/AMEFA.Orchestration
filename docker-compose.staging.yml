# Docker Compose para ambiente Staging
# Usa: docker-compose -f docker-compose.yml -f docker-compose.staging.yml up -d

services:
  # SQL Server está definido en docker-compose.yml pero se deshabilita en staging usando profiles
  # Necesitamos redefinirlo aquí con profiles: - never para que Docker Compose lo reconozca
  # pero no lo inicie. Esto es necesario porque Docker Compose valida dependencias antes
  # de aplicar profiles, así que sqlserver debe estar definido en ambos archivos.
  sqlserver:
    profiles:
      - never
  # AMEFAService.API - Configuración Staging
  api:
    # En staging, la base de datos es externa, así que no depende del servicio sqlserver local
    # Docker Compose fusiona depends_on cuando se combinan archivos, pero podemos sobrescribir
    # completamente usando una lista vacía. Sin embargo, Docker Compose valida dependencias
    # antes de aplicar profiles, así que sqlserver debe estar definido (está en docker-compose.yml).
    # Agregamos profiles: - never a sqlserver para que no se inicie, pero Docker Compose
    # todavía lo valida como dependencia. La solución es no tener depends_on en staging.
    # Nota: Esto crea una dependencia circular si api depende de gateway y gateway depende de api.
    # La solución es que api no tenga depends_on en staging (se iniciará sin esperar nada).
    depends_on: []
    environment:
      - ASPNETCORE_ENVIRONMENT=Staging
      # En staging, la base de datos es externa (db33665.databaseasp.net)
      # Si quieres usar SQL Server local en staging, comenta esta línea y usa la del docker-compose.yml
      - ConnectionStrings__DefaultConnection=${STAGING_DB_CONNECTION_STRING}
      - Jwt__Key=${JWT_KEY:-R9XNPi/qT15Ab236kuRJNqyH4HzkMnaJW+YajdIH686eK9FJZ9xaM5DDugDcVisfJ4RqGolhv6xVMeRfGBg32A==}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
      - Jwt__ExpiresInMinutes=${JWT_EXPIRES_IN_MINUTES:-120}
      - Stripe__SecretKey=${STRIPE_SECRET_KEY}
      - Stripe__PublishableKey=${STRIPE_PUBLISHABLE_KEY}
      - Stripe__WebhookSecret=${STRIPE_WEBHOOK_SECRET}
      - Email__BaseUrl=${EMAIL_BASE_URL}
      - Email__SmtpHost=${EMAIL_SMTP_HOST:-smtp.gmail.com}
      - Email__SmtpPort=${EMAIL_SMTP_PORT:-587}
      - Email__SmtpUsername=${EMAIL_SMTP_USERNAME:-abrsanchez@gmail.com}
      - Email__SmtpPassword=${EMAIL_SMTP_PASSWORD}
      - Email__FromEmail=${EMAIL_FROM_EMAIL:-abrsanchez@gmail.com}
      - Email__FromName=${EMAIL_FROM_NAME:-AMEFA}
      - Email__SupportEmail=${EMAIL_SUPPORT_EMAIL:-soporteapp@miamefa.com}
      - Email__SupportPhone=${EMAIL_SUPPORT_PHONE:-+52 3312118519}
      - Email__WebAppUrl=${EMAIL_WEBAPP_URL:-https://amefa-gzggcjcyagbjbdeb.canadacentral-01.azurewebsites.net/}
      - Email__WebAppLabel=${EMAIL_WEBAPP_LABEL:-https://www.miamefa.com}
      - MapService__Provider=${MAP_SERVICE_PROVIDER:-OpenStreetMap}
      - MapService__GoogleMaps__ApiKey=${GOOGLE_MAPS_API_KEY:-}
      - SuperAdmin__Email=${SUPERADMIN_EMAIL:-admin@amefa.com}
      - SuperAdmin__Password=${SUPERADMIN_PASSWORD:-AMEFA_Dev2024!K9#mPxvQw7@Secure}
      - SuperAdmin__FullName=${SUPERADMIN_FULLNAME:-Super Administrator}
      - Cache__Pharmacies__AbsoluteExpirationMinutes=${CACHE_PHARMACIES_ABSOLUTE:-15}
      - Cache__Pharmacies__SlidingExpirationMinutes=${CACHE_PHARMACIES_SLIDING:-5}
      - Cache__Pharmacies__Enabled=${CACHE_PHARMACIES_ENABLED:-true}
      - Cache__Users__AbsoluteExpirationMinutes=${CACHE_USERS_ABSOLUTE:-15}
      - Cache__Users__SlidingExpirationMinutes=${CACHE_USERS_SLIDING:-5}
      - Cache__Users__Enabled=${CACHE_USERS_ENABLED:-true}
      - Cache__SizeLimit=${CACHE_SIZE_LIMIT:-1024}

  # AMEFAService.Gateway - Configuración Staging
  gateway:
    # En staging, el gateway puede iniciar sin esperar a que api esté healthy
    # porque ambos servicios pueden iniciar en paralelo
    depends_on:
      api:
        condition: service_started
    environment:
      - ASPNETCORE_ENVIRONMENT=Staging
      - DOTNET_RUNNING_IN_CONTAINER=true
      - Jwt__Key=${JWT_KEY:-R9XNPi/qT15Ab236kuRJNqyH4HzkMnaJW+YajdIH686eK9FJZ9xaM5DDugDcVisfJ4RqGolhv6xVMeRfGBg32A==}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
    # En staging, el gateway apunta a la API usando el nombre del servicio Docker
    # Si la API está en el mismo Docker network, usa 'api' como host
    # Si está en un servidor externo, necesitarás configurar ocelot.Staging.Docker.json

  # AMEFA.Web - Configuración Staging
  web:
    build:
      args:
        # ⚠️ VITE_API_BASE_URL es REQUERIDO - debe estar configurado en el archivo .env.staging
        - VITE_API_BASE_URL=${VITE_API_BASE_URL}
        # NODE_ENV debe ser 'staging' para staging
        - NODE_ENV=staging
    environment:
      - NODE_ENV=staging
      - PORT=8080
